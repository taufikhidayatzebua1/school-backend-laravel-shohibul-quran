<!DOCTYPE html>
<html lang="id">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Data Hafalan Siswa - Full CRUD</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                padding: 20px;
            }

            .container {
                max-width: 1200px;
                margin: 0 auto;
            }

            .header {
                background: white;
                padding: 30px;
                border-radius: 15px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
                margin-bottom: 30px;
                text-align: center;
            }

            .header h1 {
                color: #667eea;
                font-size: 2.5em;
                margin-bottom: 10px;
            }

            .header p {
                color: #666;
                font-size: 1.1em;
            }

            .badge {
                display: inline-block;
                padding: 5px 12px;
                background: #4caf50;
                color: white;
                border-radius: 20px;
                font-size: 0.85em;
                margin-top: 10px;
            }

            .filter-section {
                background: white;
                padding: 25px;
                border-radius: 15px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
                margin-bottom: 30px;
            }

            .filter-section label {
                display: block;
                margin-bottom: 10px;
                color: #333;
                font-weight: 600;
                font-size: 1.1em;
            }

            .filter-section select {
                width: 100%;
                padding: 15px;
                border: 2px solid #e0e0e0;
                border-radius: 10px;
                font-size: 1em;
                cursor: pointer;
                transition: all 0.3s ease;
                background: white;
            }

            .filter-section select:hover {
                border-color: #667eea;
            }

            .filter-section select:focus {
                outline: none;
                border-color: #667eea;
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            }

            .loading {
                text-align: center;
                padding: 40px;
                background: white;
                border-radius: 15px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
                display: none;
            }

            .loading.active {
                display: block;
            }

            .loading-spinner {
                border: 4px solid #f3f3f3;
                border-top: 4px solid #667eea;
                border-radius: 50%;
                width: 50px;
                height: 50px;
                animation: spin 1s linear infinite;
                margin: 0 auto 20px;
            }

            @keyframes spin {
                0% {
                    transform: rotate(0deg);
                }
                100% {
                    transform: rotate(360deg);
                }
            }

            .students-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
                gap: 25px;
                display: none;
            }

            .students-grid.active {
                display: grid;
            }

            .student-card {
                background: white;
                border-radius: 15px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
                overflow: hidden;
                transition: transform 0.3s ease, box-shadow 0.3s ease;
            }

            .student-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
            }

            .student-header {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 25px;
            }

            .student-header h3 {
                font-size: 1.5em;
                margin-bottom: 5px;
            }

            .student-header p {
                opacity: 0.9;
                font-size: 0.95em;
            }

            .student-info {
                padding: 20px;
            }

            .info-item {
                display: flex;
                justify-content: space-between;
                padding: 10px 0;
                border-bottom: 1px solid #f0f0f0;
            }

            .info-item:last-child {
                border-bottom: none;
            }

            .info-label {
                color: #666;
                font-weight: 600;
            }

            .info-value {
                color: #333;
            }

            .stats-preview {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
                margin-top: 15px;
                padding: 15px;
                background: #f8f9fa;
                border-radius: 10px;
            }

            .stat-mini {
                text-align: center;
            }

            .stat-mini-number {
                font-size: 1.5em;
                font-weight: bold;
                color: #667eea;
            }

            .stat-mini.lancar .stat-mini-number {
                color: #4caf50;
            }
            .stat-mini.perlu-bimbingan .stat-mini-number {
                color: #ff9800;
            }
            .stat-mini.mengulang .stat-mini-number {
                color: #f44336;
            }

            .stat-mini-label {
                font-size: 0.75em;
                color: #666;
                margin-top: 3px;
            }

            .detail-button {
                width: 100%;
                padding: 15px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border: none;
                border-radius: 0;
                cursor: pointer;
                font-size: 1em;
                font-weight: 600;
                transition: all 0.3s ease;
            }

            .detail-button:hover:not(:disabled) {
                background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            }

            .detail-button:disabled {
                opacity: 0.7;
                cursor: not-allowed;
            }

            .detail-button.active {
                background: #f44336;
            }

            .detail-button.loading {
                background: #999;
            }

            .hafalan-detail {
                max-height: 0;
                overflow: hidden;
                transition: max-height 0.3s ease;
                background: #f8f9fa;
            }

            .hafalan-detail.active {
                max-height: 5000px;
            }

            .hafalan-content {
                padding: 20px;
            }

            .hafalan-header-section {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
            }

            .add-hafalan-btn {
                padding: 10px 20px;
                background: #4caf50;
                color: white;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
                transition: all 0.3s ease;
            }

            .add-hafalan-btn:hover {
                background: #45a049;
                transform: translateY(-2px);
            }

            .hafalan-stats {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 15px;
                margin-bottom: 20px;
            }

            .stat-box {
                background: white;
                padding: 15px;
                border-radius: 10px;
                text-align: center;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }

            .stat-number {
                font-size: 2em;
                font-weight: bold;
                color: #667eea;
            }

            .stat-label {
                font-size: 0.85em;
                color: #666;
                margin-top: 5px;
            }

            .hafalan-list {
                display: grid;
                gap: 15px;
            }

            .hafalan-item {
                background: white;
                padding: 15px;
                border-radius: 10px;
                border-left: 4px solid #667eea;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                position: relative;
            }

            .hafalan-item.lancar {
                border-left-color: #4caf50;
            }

            .hafalan-item.perlu_bimbingan {
                border-left-color: #ff9800;
            }

            .hafalan-item.mengulang {
                border-left-color: #f44336;
            }

            .hafalan-item-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 10px;
            }

            .surah-name {
                font-weight: bold;
                color: #333;
                font-size: 1.1em;
            }

            .hafalan-actions {
                display: flex;
                gap: 8px;
            }

            .action-btn {
                padding: 6px 12px;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                font-size: 0.85em;
                font-weight: 600;
                transition: all 0.3s ease;
            }

            .edit-btn {
                background: #2196f3;
                color: white;
            }

            .edit-btn:hover {
                background: #1976d2;
            }

            .delete-btn {
                background: #f44336;
                color: white;
            }

            .delete-btn:hover {
                background: #d32f2f;
            }

            .status-badge {
                padding: 5px 15px;
                border-radius: 20px;
                font-size: 0.85em;
                font-weight: 600;
                color: white;
            }

            .status-badge.lancar {
                background: #4caf50;
            }

            .status-badge.perlu_bimbingan {
                background: #ff9800;
            }

            .status-badge.mengulang {
                background: #f44336;
            }

            .hafalan-info {
                color: #666;
                font-size: 0.9em;
                margin-top: 5px;
            }

            .hafalan-guru {
                margin-top: 10px;
                padding-top: 10px;
                border-top: 1px solid #f0f0f0;
                font-size: 0.85em;
                color: #888;
            }

            /* Modal Styles */
            .modal {
                display: none;
                position: fixed;
                z-index: 1000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
                animation: fadeIn 0.3s;
            }

            .modal.active {
                display: flex;
                justify-content: center;
                align-items: center;
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                }
                to {
                    opacity: 1;
                }
            }

            .modal-content {
                background: white;
                padding: 30px;
                border-radius: 15px;
                width: 90%;
                max-width: 600px;
                max-height: 90vh;
                overflow-y: auto;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                animation: slideUp 0.3s;
            }

            @keyframes slideUp {
                from {
                    transform: translateY(50px);
                    opacity: 0;
                }
                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }

            .modal-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 25px;
                padding-bottom: 15px;
                border-bottom: 2px solid #f0f0f0;
            }

            .modal-header h2 {
                color: #667eea;
                font-size: 1.8em;
            }

            .close-btn {
                background: none;
                border: none;
                font-size: 2em;
                cursor: pointer;
                color: #999;
                line-height: 1;
                padding: 0;
                width: 40px;
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
                transition: all 0.3s ease;
            }

            .close-btn:hover {
                background: #f0f0f0;
                color: #333;
            }

            .form-group {
                margin-bottom: 20px;
            }

            .form-group label {
                display: block;
                margin-bottom: 8px;
                color: #333;
                font-weight: 600;
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                width: 100%;
                padding: 12px;
                border: 2px solid #e0e0e0;
                border-radius: 8px;
                font-size: 1em;
                transition: all 0.3s ease;
            }

            .form-group input:focus,
            .form-group select:focus,
            .form-group textarea:focus {
                outline: none;
                border-color: #667eea;
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            }

            .form-group textarea {
                resize: vertical;
                min-height: 80px;
            }

            .form-row {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }

            .modal-actions {
                display: flex;
                gap: 15px;
                justify-content: flex-end;
                margin-top: 25px;
            }

            .btn {
                padding: 12px 30px;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-size: 1em;
                font-weight: 600;
                transition: all 0.3s ease;
            }

            .btn-primary {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
            }

            .btn-primary:hover {
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            }

            .btn-secondary {
                background: #e0e0e0;
                color: #333;
            }

            .btn-secondary:hover {
                background: #d0d0d0;
            }

            .no-data {
                text-align: center;
                padding: 60px 20px;
                background: white;
                border-radius: 15px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
                display: none;
            }

            .no-data.active {
                display: block;
            }

            .no-data-icon {
                font-size: 5em;
                margin-bottom: 20px;
            }

            .no-data h3 {
                color: #333;
                font-size: 1.5em;
                margin-bottom: 10px;
            }

            .no-data p {
                color: #666;
            }

            .empty-hafalan {
                text-align: center;
                padding: 40px;
                color: #999;
            }

            .empty-hafalan-icon {
                font-size: 3em;
                margin-bottom: 15px;
            }

            .error-message {
                background: #ffebee;
                color: #c62828;
                padding: 12px;
                border-radius: 8px;
                margin-bottom: 15px;
                border-left: 4px solid #c62828;
            }

            .success-message {
                background: #e8f5e9;
                color: #2e7d32;
                padding: 12px;
                border-radius: 8px;
                margin-bottom: 15px;
                border-left: 4px solid #2e7d32;
            }

            @media (max-width: 768px) {
                .students-grid {
                    grid-template-columns: 1fr;
                }

                .hafalan-stats,
                .stats-preview {
                    grid-template-columns: 1fr;
                }

                .header h1 {
                    font-size: 1.8em;
                }

                .form-row {
                    grid-template-columns: 1fr;
                }

                .modal-content {
                    width: 95%;
                    padding: 20px;
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <!-- Header -->
            <div class="header">
                <h1>üìñ Data Hafalan Siswa</h1>
                <p>Sistem Monitoring Hafalan Al-Qur'an</p>
                <span class="badge">‚ú® Full CRUD - Optimized Version</span>
            </div>

            <!-- Filter Section -->
            <div class="filter-section">
                <label for="kelasSelect">üéì Pilih Kelas:</label>
                <select id="kelasSelect">
                    <option value="">-- Pilih Kelas --</option>
                </select>
            </div>

            <!-- Loading -->
            <div class="loading" id="loading">
                <div class="loading-spinner"></div>
                <p>Memuat data...</p>
            </div>

            <!-- No Data -->
            <div class="no-data" id="noData">
                <div class="no-data-icon">üìö</div>
                <h3>Belum Ada Kelas Dipilih</h3>
                <p>
                    Silakan pilih kelas terlebih dahulu untuk melihat data siswa
                </p>
            </div>

            <!-- Students Grid -->
            <div class="students-grid" id="studentsGrid"></div>
        </div>

        <!-- Modal Form Hafalan -->
        <div class="modal" id="hafalanModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modalTitle">Tambah Hafalan</h2>
                    <button class="close-btn" onclick="closeModal()">
                        &times;
                    </button>
                </div>
                <div id="modalMessage"></div>
                <form id="hafalanForm">
                    <input type="hidden" id="hafalanId" />
                    <input type="hidden" id="siswaId" />

                    <div class="form-group">
                        <label for="guruSelect">Guru Penguji *</label>
                        <select id="guruSelect" required>
                            <option value="">-- Pilih Guru --</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="surahSelect">Surah *</label>
                        <select id="surahSelect" required>
                            <option value="">-- Pilih Surah --</option>
                        </select>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="ayatDari">Ayat Dari *</label>
                            <input
                                type="number"
                                id="ayatDari"
                                min="1"
                                required
                            />
                        </div>
                        <div class="form-group">
                            <label for="ayatSampai">Ayat Sampai *</label>
                            <input
                                type="number"
                                id="ayatSampai"
                                min="1"
                                required
                            />
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="statusSelect">Status *</label>
                        <select id="statusSelect" required>
                            <option value="">-- Pilih Status --</option>
                            <option value="lancar">Lancar</option>
                            <option value="perlu bimbingan">
                                Perlu Bimbingan
                            </option>
                            <option value="mengulang">Mengulang</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="tanggalInput">Tanggal *</label>
                        <input type="date" id="tanggalInput" required />
                    </div>

                    <div class="form-group">
                        <label for="keteranganInput">Keterangan</label>
                        <textarea
                            id="keteranganInput"
                            placeholder="Tambahkan catatan (opsional)"
                        ></textarea>
                    </div>

                    <div class="modal-actions">
                        <button
                            type="button"
                            class="btn btn-secondary"
                            onclick="closeModal()"
                        >
                            Batal
                        </button>
                        <button type="submit" class="btn btn-primary">
                            Simpan
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <script>
            const API_BASE_URL = "http://localhost:8000/api";
            const kelasSelect = document.getElementById("kelasSelect");
            const loading = document.getElementById("loading");
            const noData = document.getElementById("noData");
            const studentsGrid = document.getElementById("studentsGrid");
            const hafalanModal = document.getElementById("hafalanModal");
            const hafalanForm = document.getElementById("hafalanForm");
            const modalTitle = document.getElementById("modalTitle");
            const modalMessage = document.getElementById("modalMessage");

            let currentSiswaData = null;
            let allGuru = [];

            // Daftar nama Surah (1-114)
            const surahNames = [
                "Al-Fatihah",
                "Al-Baqarah",
                "Ali 'Imran",
                "An-Nisa",
                "Al-Ma'idah",
                "Al-An'am",
                "Al-A'raf",
                "Al-Anfal",
                "At-Taubah",
                "Yunus",
                "Hud",
                "Yusuf",
                "Ar-Ra'd",
                "Ibrahim",
                "Al-Hijr",
                "An-Nahl",
                "Al-Isra",
                "Al-Kahf",
                "Maryam",
                "Taha",
                "Al-Anbya",
                "Al-Hajj",
                "Al-Mu'minun",
                "An-Nur",
                "Al-Furqan",
                "Ash-Shu'ara",
                "An-Naml",
                "Al-Qasas",
                "Al-'Ankabut",
                "Ar-Rum",
                "Luqman",
                "As-Sajdah",
                "Al-Ahzab",
                "Saba",
                "Fatir",
                "Ya-Sin",
                "As-Saffat",
                "Sad",
                "Az-Zumar",
                "Ghafir",
                "Fussilat",
                "Ash-Shuraa",
                "Az-Zukhruf",
                "Ad-Dukhan",
                "Al-Jathiyah",
                "Al-Ahqaf",
                "Muhammad",
                "Al-Fath",
                "Al-Hujurat",
                "Qaf",
                "Adh-Dhariyat",
                "At-Tur",
                "An-Najm",
                "Al-Qamar",
                "Ar-Rahman",
                "Al-Waqi'ah",
                "Al-Hadid",
                "Al-Mujadila",
                "Al-Hashr",
                "Al-Mumtahanah",
                "As-Saf",
                "Al-Jumu'ah",
                "Al-Munafiqun",
                "At-Taghabun",
                "At-Talaq",
                "At-Tahrim",
                "Al-Mulk",
                "Al-Qalam",
                "Al-Haqqah",
                "Al-Ma'arij",
                "Nuh",
                "Al-Jinn",
                "Al-Muzzammil",
                "Al-Muddaththir",
                "Al-Qiyamah",
                "Al-Insan",
                "Al-Mursalat",
                "An-Naba",
                "An-Nazi'at",
                "Abasa",
                "'Adiyat",
                "At-Takwir",
                "Al-Infitar",
                "Al-Mutaffifin",
                "Al-Inshiqaq",
                "Al-Buruj",
                "At-Tariq",
                "Al-A'la",
                "Al-Ghashiyah",
                "Al-Fajr",
                "Al-Balad",
                "Ash-Shams",
                "Al-Lail",
                "Ad-Duhaa",
                "Ash-Sharh",
                "At-Tin",
                "Al-'Alaq",
                "Al-Qadr",
                "Al-Bayyinah",
                "Az-Zalzalah",
                "Al-'Adiyat",
                "Al-Qari'ah",
                "At-Takathur",
                "Al-'Asr",
                "Al-Humazah",
                "Al-Fil",
                "Quraish",
                "Al-Ma'un",
                "Al-Kauthar",
                "Al-Kafirun",
                "An-Nasr",
                "Al-Masad",
                "Al-Ikhlas",
                "Al-Falaq",
                "An-Nas",
            ];

            // Load initial data
            async function loadKelasList() {
                try {
                    const response = await fetch(`${API_BASE_URL}/kelas`);
                    const data = await response.json();

                    if (data.success && data.data) {
                        data.data.forEach((kelas) => {
                            const option = document.createElement("option");
                            option.value = kelas.id;
                            option.textContent = `${kelas.nama_kelas} (${kelas.siswa_count} siswa)`;
                            kelasSelect.appendChild(option);
                        });
                    }
                } catch (error) {
                    console.error("Error loading kelas:", error);
                }
            }

            async function loadGuruList() {
                try {
                    // Assuming there's an API endpoint for guru list
                    // If not, we'll populate from hafalan data
                    const response = await fetch(
                        `${API_BASE_URL}/hafalan?per_page=100`
                    );
                    const data = await response.json();

                    if (data.success && data.data.data) {
                        const guruSet = new Set();
                        data.data.data.forEach((hafalan) => {
                            if (hafalan.guru) {
                                guruSet.add(
                                    JSON.stringify({
                                        id: hafalan.guru.id,
                                        nama: hafalan.guru.nama,
                                    })
                                );
                            }
                        });

                        allGuru = Array.from(guruSet).map((g) => JSON.parse(g));
                        allGuru.sort((a, b) => a.nama.localeCompare(b.nama));

                        const guruSelect =
                            document.getElementById("guruSelect");
                        allGuru.forEach((guru) => {
                            const option = document.createElement("option");
                            option.value = guru.id;
                            option.textContent = guru.nama;
                            guruSelect.appendChild(option);
                        });
                    }
                } catch (error) {
                    console.error("Error loading guru:", error);
                }
            }

            function populateSurahSelect() {
                const surahSelect = document.getElementById("surahSelect");
                surahNames.forEach((surah, index) => {
                    const option = document.createElement("option");
                    option.value = index + 1;
                    option.textContent = `${index + 1}. ${surah}`;
                    surahSelect.appendChild(option);
                });
            }

            function getSurahName(surahId) {
                return surahNames[surahId - 1] || `Surah ${surahId}`;
            }

            function formatDate(dateString) {
                if (!dateString) return "-";
                const options = {
                    year: "numeric",
                    month: "long",
                    day: "numeric",
                };
                return new Date(dateString).toLocaleDateString(
                    "id-ID",
                    options
                );
            }

            function formatStatus(status) {
                const statusMap = {
                    lancar: "Lancar",
                    "perlu bimbingan": "Perlu Bimbingan",
                    perlu_bimbingan: "Perlu Bimbingan",
                    mengulang: "Mengulang",
                };
                return statusMap[status] || status;
            }

            function normalizeStatus(status) {
                return status.replace(/ /g, "_");
            }

            // STEP 1: Load siswa list
            async function loadStudentsByKelas(kelasId) {
                loading.classList.add("active");
                noData.classList.remove("active");
                studentsGrid.classList.remove("active");
                studentsGrid.innerHTML = "";

                try {
                    const response = await fetch(
                        `${API_BASE_URL}/kelas/${kelasId}/siswa`
                    );
                    const data = await response.json();

                    if (data.success && data.data.siswa) {
                        if (data.data.siswa.length === 0) {
                            noData.querySelector("h3").textContent =
                                "Tidak Ada Data Siswa";
                            noData.querySelector("p").textContent =
                                "Belum ada siswa di kelas ini";
                            noData.classList.add("active");
                        } else {
                            data.data.siswa.forEach((siswa) => {
                                const card = createStudentCard(siswa);
                                studentsGrid.appendChild(card);
                            });

                            studentsGrid.classList.add("active");
                        }
                    }
                } catch (error) {
                    console.error("Error loading students:", error);
                    alert("Terjadi kesalahan saat memuat data");
                } finally {
                    loading.classList.remove("active");
                }
            }

            function createStudentCard(siswa) {
                const card = document.createElement("div");
                card.className = "student-card";
                card.dataset.siswaId = siswa.id;

                const stats = siswa.hafalan_stats || {
                    total: 0,
                    lancar: 0,
                    perlu_bimbingan: 0,
                    mengulang: 0,
                };

                card.innerHTML = `
                <div class="student-header">
                    <h3>${siswa.nama}</h3>
                    <p>NIS: ${siswa.nis}</p>
                </div>
                <div class="student-info">
                    <div class="info-item">
                        <span class="info-label">Jenis Kelamin</span>
                        <span class="info-value">${
                            siswa.jenis_kelamin === "L"
                                ? "Laki-laki"
                                : "Perempuan"
                        }</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Tanggal Lahir</span>
                        <span class="info-value">${formatDate(
                            siswa.tanggal_lahir
                        )}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Total Hafalan</span>
                        <span class="info-value">${stats.total} Hafalan</span>
                    </div>
                    ${
                        siswa.latest_hafalan_date
                            ? `
                    <div class="info-item">
                        <span class="info-label">Terakhir Setoran</span>
                        <span class="info-value">${formatDate(
                            siswa.latest_hafalan_date
                        )}</span>
                    </div>
                    `
                            : ""
                    }
                </div>
                ${
                    stats.total > 0
                        ? `
                <div class="stats-preview">
                    <div class="stat-mini lancar">
                        <div class="stat-mini-number">${stats.lancar}</div>
                        <div class="stat-mini-label">Lancar</div>
                    </div>
                    <div class="stat-mini perlu-bimbingan">
                        <div class="stat-mini-number">${stats.perlu_bimbingan}</div>
                        <div class="stat-mini-label">Perlu Bimbingan</div>
                    </div>
                    <div class="stat-mini mengulang">
                        <div class="stat-mini-number">${stats.mengulang}</div>
                        <div class="stat-mini-label">Mengulang</div>
                    </div>
                </div>
                `
                        : ""
                }
                <button class="detail-button" onclick="loadAndToggleHafalan(${
                    siswa.id
                }, this)">
                    üìã Lihat Detail Hafalan
                </button>
                <div class="hafalan-detail" data-loaded="false">
                    <div class="hafalan-content"></div>
                </div>
            `;

                return card;
            }

            // STEP 2: Load hafalan detail
            async function loadAndToggleHafalan(siswaId, button) {
                const card = button.closest(".student-card");
                const detailDiv = card.querySelector(".hafalan-detail");
                const contentDiv = detailDiv.querySelector(".hafalan-content");

                if (detailDiv.dataset.loaded === "true") {
                    button.classList.toggle("active");
                    detailDiv.classList.toggle("active");

                    if (button.classList.contains("active")) {
                        button.textContent = "‚ùå Tutup Detail";
                    } else {
                        button.textContent = "üìã Lihat Detail Hafalan";
                    }
                    return;
                }

                button.disabled = true;
                button.classList.add("loading");
                button.textContent = "‚è≥ Memuat hafalan...";

                try {
                    const response = await fetch(
                        `${API_BASE_URL}/siswa/${siswaId}/hafalan`
                    );
                    const data = await response.json();

                    if (data.success) {
                        currentSiswaData = data.data.siswa;
                        const hafalanList = data.data.hafalan;
                        const stats = data.data.statistics;

                        contentDiv.innerHTML = renderHafalanContent(
                            siswaId,
                            hafalanList,
                            stats
                        );

                        detailDiv.dataset.loaded = "true";
                        detailDiv.classList.add("active");
                        button.classList.add("active");
                        button.textContent = "‚ùå Tutup Detail";
                    }
                } catch (error) {
                    console.error("Error loading hafalan:", error);
                    contentDiv.innerHTML = `
                    <div class="empty-hafalan">
                        <div class="empty-hafalan-icon">‚ö†Ô∏è</div>
                        <p>Gagal memuat data hafalan</p>
                    </div>
                `;
                } finally {
                    button.disabled = false;
                    button.classList.remove("loading");
                }
            }

            function renderHafalanContent(siswaId, hafalanList, stats) {
                return `
                <div class="hafalan-header-section">
                    <h3>Daftar Hafalan</h3>
                    <button class="add-hafalan-btn" onclick="openAddModal(${siswaId})">
                        ‚ûï Tambah Hafalan
                    </button>
                </div>
                ${
                    hafalanList.length > 0
                        ? `
                    <div class="hafalan-stats">
                        <div class="stat-box">
                            <div class="stat-number">${stats.lancar}</div>
                            <div class="stat-label">Lancar</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number">${
                                stats.perlu_bimbingan
                            }</div>
                            <div class="stat-label">Perlu Bimbingan</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number">${stats.mengulang}</div>
                            <div class="stat-label">Mengulang</div>
                        </div>
                    </div>
                    <div class="hafalan-list">
                        ${hafalanList
                            .map(
                                (h) => `
                            <div class="hafalan-item ${normalizeStatus(
                                h.status
                            )}" data-hafalan-id="${h.id}">
                                <div class="hafalan-item-header">
                                    <span class="surah-name">${getSurahName(
                                        h.surah_id
                                    )}</span>
                                    <div class="hafalan-actions">
                                        <button class="action-btn edit-btn" onclick="openEditModal(${
                                            h.id
                                        })">
                                            ‚úèÔ∏è Edit
                                        </button>
                                        <button class="action-btn delete-btn" onclick="deleteHafalan(${
                                            h.id
                                        })">
                                            üóëÔ∏è Hapus
                                        </button>
                                    </div>
                                </div>
                                <div style="margin-top: 10px;">
                                    <span class="status-badge ${normalizeStatus(
                                        h.status
                                    )}">${formatStatus(h.status)}</span>
                                </div>
                                <div class="hafalan-info">
                                    üìñ Ayat ${h.ayat_dari} - ${h.ayat_sampai} | 
                                    üìÖ ${formatDate(h.tanggal)}
                                </div>
                                ${
                                    h.keterangan
                                        ? `<div class="hafalan-info">üí¨ ${h.keterangan}</div>`
                                        : ""
                                }
                                ${
                                    h.guru
                                        ? `
                                    <div class="hafalan-guru">
                                        üë®‚Äçüè´ Penguji: ${h.guru.nama}
                                    </div>
                                `
                                        : ""
                                }
                            </div>
                        `
                            )
                            .join("")}
                    </div>
                `
                        : `
                    <div class="empty-hafalan">
                        <div class="empty-hafalan-icon">üìö</div>
                        <p>Belum ada data hafalan</p>
                        <p style="margin-top: 10px;">Klik tombol "Tambah Hafalan" untuk menambah data</p>
                    </div>
                `
                }
            `;
            }

            // Modal Functions
            function openAddModal(siswaId) {
                modalTitle.textContent = "Tambah Hafalan";
                document.getElementById("hafalanId").value = "";
                document.getElementById("siswaId").value = siswaId;
                hafalanForm.reset();
                document.getElementById("tanggalInput").valueAsDate =
                    new Date();
                modalMessage.innerHTML = "";
                hafalanModal.classList.add("active");
            }

            async function openEditModal(hafalanId) {
                try {
                    const response = await fetch(
                        `${API_BASE_URL}/hafalan/${hafalanId}`
                    );
                    const data = await response.json();

                    if (data.success) {
                        const hafalan = data.data;

                        modalTitle.textContent = "Edit Hafalan";
                        document.getElementById("hafalanId").value = hafalan.id;
                        document.getElementById("siswaId").value =
                            hafalan.siswa_id;
                        document.getElementById("guruSelect").value =
                            hafalan.guru_id;
                        document.getElementById("surahSelect").value =
                            hafalan.surah_id;
                        document.getElementById("ayatDari").value =
                            hafalan.ayat_dari;
                        document.getElementById("ayatSampai").value =
                            hafalan.ayat_sampai;
                        document.getElementById("statusSelect").value =
                            hafalan.status;
                        document.getElementById("tanggalInput").value =
                            hafalan.tanggal;
                        document.getElementById("keteranganInput").value =
                            hafalan.keterangan || "";
                        modalMessage.innerHTML = "";

                        hafalanModal.classList.add("active");
                    }
                } catch (error) {
                    console.error("Error loading hafalan detail:", error);
                    alert("Gagal memuat data hafalan");
                }
            }

            function closeModal() {
                hafalanModal.classList.remove("active");
                hafalanForm.reset();
                modalMessage.innerHTML = "";
            }

            // CRUD Operations
            hafalanForm.addEventListener("submit", async (e) => {
                e.preventDefault();

                const hafalanId = document.getElementById("hafalanId").value;
                const siswaId = document.getElementById("siswaId").value;

                const formData = {
                    siswa_id: siswaId,
                    guru_id: document.getElementById("guruSelect").value,
                    surah_id: parseInt(
                        document.getElementById("surahSelect").value
                    ),
                    ayat_dari: parseInt(
                        document.getElementById("ayatDari").value
                    ),
                    ayat_sampai: parseInt(
                        document.getElementById("ayatSampai").value
                    ),
                    status: document.getElementById("statusSelect").value,
                    tanggal: document.getElementById("tanggalInput").value,
                    keterangan:
                        document.getElementById("keteranganInput").value,
                };

                try {
                    let response;
                    if (hafalanId) {
                        // Update
                        response = await fetch(
                            `${API_BASE_URL}/hafalan/${hafalanId}`,
                            {
                                method: "PUT",
                                headers: {
                                    "Content-Type": "application/json",
                                    Accept: "application/json",
                                },
                                body: JSON.stringify(formData),
                            }
                        );
                    } else {
                        // Create
                        response = await fetch(`${API_BASE_URL}/hafalan`, {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                Accept: "application/json",
                            },
                            body: JSON.stringify(formData),
                        });
                    }

                    const data = await response.json();

                    if (data.success) {
                        modalMessage.innerHTML = `
                        <div class="success-message">
                            ${
                                hafalanId
                                    ? "Hafalan berhasil diupdate!"
                                    : "Hafalan berhasil ditambahkan!"
                            }
                        </div>
                    `;

                        setTimeout(() => {
                            closeModal();
                            reloadHafalanDetail(siswaId);
                        }, 1500);
                    } else {
                        modalMessage.innerHTML = `
                        <div class="error-message">
                            ${
                                data.message ||
                                "Terjadi kesalahan saat menyimpan data"
                            }
                        </div>
                    `;
                    }
                } catch (error) {
                    console.error("Error saving hafalan:", error);
                    modalMessage.innerHTML = `
                    <div class="error-message">
                        Terjadi kesalahan saat menyimpan data
                    </div>
                `;
                }
            });

            async function deleteHafalan(hafalanId) {
                if (
                    !confirm("Apakah Anda yakin ingin menghapus hafalan ini?")
                ) {
                    return;
                }

                try {
                    const response = await fetch(
                        `${API_BASE_URL}/hafalan/${hafalanId}`,
                        {
                            method: "DELETE",
                            headers: {
                                Accept: "application/json",
                            },
                        }
                    );

                    const data = await response.json();

                    if (data.success) {
                        // Find and get siswa_id from the hafalan item
                        const hafalanItem = document.querySelector(
                            `[data-hafalan-id="${hafalanId}"]`
                        );
                        const card = hafalanItem.closest(".student-card");
                        const siswaId = card.dataset.siswaId;

                        // Remove the hafalan item with animation
                        hafalanItem.style.opacity = "0";
                        hafalanItem.style.transform = "translateX(-20px)";

                        setTimeout(() => {
                            reloadHafalanDetail(siswaId);
                        }, 300);
                    } else {
                        alert(
                            "Gagal menghapus hafalan: " +
                                (data.message || "Unknown error")
                        );
                    }
                } catch (error) {
                    console.error("Error deleting hafalan:", error);
                    alert("Terjadi kesalahan saat menghapus data");
                }
            }

            async function reloadHafalanDetail(siswaId) {
                try {
                    const response = await fetch(
                        `${API_BASE_URL}/siswa/${siswaId}/hafalan`
                    );
                    const data = await response.json();

                    if (data.success) {
                        const card = document.querySelector(
                            `[data-siswa-id="${siswaId}"]`
                        );
                        const contentDiv =
                            card.querySelector(".hafalan-content");
                        const hafalanList = data.data.hafalan;
                        const stats = data.data.statistics;

                        contentDiv.innerHTML = renderHafalanContent(
                            siswaId,
                            hafalanList,
                            stats
                        );

                        // Update stats preview in card header
                        const statsPreview =
                            card.querySelector(".stats-preview");
                        if (statsPreview) {
                            statsPreview.innerHTML = `
                            <div class="stat-mini lancar">
                                <div class="stat-mini-number">${stats.lancar}</div>
                                <div class="stat-mini-label">Lancar</div>
                            </div>
                            <div class="stat-mini perlu-bimbingan">
                                <div class="stat-mini-number">${stats.perlu_bimbingan}</div>
                                <div class="stat-mini-label">Perlu Bimbingan</div>
                            </div>
                            <div class="stat-mini mengulang">
                                <div class="stat-mini-number">${stats.mengulang}</div>
                                <div class="stat-mini-label">Mengulang</div>
                            </div>
                        `;
                        }

                        // Update total hafalan
                        const totalHafalanSpan = card.querySelector(
                            ".info-item .info-value"
                        );
                        if (
                            totalHafalanSpan &&
                            totalHafalanSpan.textContent.includes("Hafalan")
                        ) {
                            totalHafalanSpan.textContent = `${stats.total} Hafalan`;
                        }
                    }
                } catch (error) {
                    console.error("Error reloading hafalan:", error);
                }
            }

            // Event Listeners
            kelasSelect.addEventListener("change", (e) => {
                const kelasId = e.target.value;

                if (kelasId) {
                    loadStudentsByKelas(kelasId);
                } else {
                    studentsGrid.classList.remove("active");
                    studentsGrid.innerHTML = "";
                    noData.querySelector("h3").textContent =
                        "Belum Ada Kelas Dipilih";
                    noData.querySelector("p").textContent =
                        "Silakan pilih kelas terlebih dahulu untuk melihat data siswa";
                    noData.classList.add("active");
                }
            });

            // Close modal when clicking outside
            hafalanModal.addEventListener("click", (e) => {
                if (e.target === hafalanModal) {
                    closeModal();
                }
            });

            // Initialize
            loadKelasList();
            loadGuruList();
            populateSurahSelect();
            noData.classList.add("active");
        </script>
    </body>
</html>
